git:
  depth: 3

#switch to node as default next time
language: csharp
solution: NetCoreSample.sln
sudo: required
dist: trusty
env:
  matrix:
  - DOTNET_BUILD=1 CLI_VERSION=latest DOTNET_INSTALL_DIR="$PWD/.dotnetcli" PATH="$DOTNET_INSTALL_DIR:$PATH"
  - NOD E_BUILD=1
  global:
  # GITHUB_TOKEN
  - secure: M2KrT/u56joO2tbnDn8udpH69JX4PJgx7tGcEzE7Q1FLvEVacJL4THtt0trlBDSQBF2KObgLTlULcEmcAFsrA3F9K7VK/uAvFHqQKzzBcYWIMFPZiuV5pOWsBTkyGo/Q6cqe0R+R2haPAo7M0ZDuQTVGY/AzvZq329TFoinFrj1OCLq/gPICvoMbgkQ5ibK436GGTavn6QmdV6EobcaHUu2whepT68ORp1T/HfyTJjp2KyqtgO4I3maG/94I8xRfnqoRoajMB1vgYhgdGczMBjQuVAeLjqyHR14ikVPuxOROiAfjb2sss0vqa9rf3lgNBNjqJ5Y/ctEpviZ6Nj1y3J58ExjgemJaGMmIDVcyVrzh5d/HPyQhKmuQcXzP1xxMnVnhk1zQ/Q13iKdCEUFadgeX3BHzT/2++Cmz0oFVbYtpNqDrysQZu5UpNc4B3zYTbK0vYfJTgMdqKgOxe9kRGRxlr53w8OcWAvWGkLf4x+Is0xqJVyeWjxcAUjMU28SJHTzswgOM+s6iLbfJIjpAaT4ttHmdKb7rvOLFrkz+NsrQOjVp35DAPTw/HXssYKJmfn/AtvFXnZpBaNQ0cFDNMkB9Hdoeae5wVAroHjg+3SmTCRiJ4IS1mbZuSoS7DWN6TTl5zh1N27k3AZjVIBvOBfqcIwrkf1QLK2HAXdL+vHc=
  - GIT_DEPLOY_REPO=https://$GITHUB_TOKEN@github.com/ITILostTime/ArchitectureBuildTest.git

mono:
- 4.2.3
os:
- linux

branches:
  except:
  - branchNonBuilded
  only:
  - release
  - dev

before_install:
#check if we are not not a TAG or not on Branch : release or dev : leave the build
#- if [ -z "$TRAVIS_TAG" ]; then if [ "$TRAVIS_BRANCH" != "release" ]; then if [ "$TRAVIS_BRANCH" != "dev" ]; then exit 0; fi fi fi
- chmod +x ./scripts/dotnetbuild.sh
- chmod +x ./scripts/set_tags.sh
- |
  if [[ "${DOTNET_BUILD+x}" ]]; then
    sudo apt-get install -y gettext libcurl4-openssl-dev libicu-dev libssl-dev libunwind8 zlib1g
  fi

install:
- |
  if [[ "${DOTNET_BUILD+x}" ]]; then
    curl -sSL https://raw.githubusercontent.com/dotnet/cli/rel/1.0.0/scripts/obtain/dotnet-install.sh | bash /dev/stdin --version "$CLI_VERSION" --install-dir "$DOTNET_INSTALL_DIR"
  fi
- |
  if [[ "${NODE_BUILD+x}" ]]; then
    nvm install stable
    nvm use stable
    pushd ./src/ITI.PrimarySchool.WebApp/App/primary-school && yarn && popd
  fi

script:
- |
  if [[ "${DOTNET_BUILD+x}" ]]; then
    ./scripts/dotnetbuild.sh
  fi
- |
  if [[ "${NODE_BUILD+x}" ]]; then
    pushd ./src/ITI.PrimarySchool.WebApp/App/primary-school && yarn build && popd
    #js test
  fi

#set tag version based on the file at the root of the system
after_success:
- ./scripts/set_tags.sh

before_deploy:
- echo "deploying to GitHub releases"

deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: $GITHUB_TOKEN
  file_glob: true
  file: "$TRAVIS_BUILD_DIR/artifacts/*"
  on:
    tags: true
    repo: ITILostTime/ArchitectureBuildTest
    
notifications:
  email:
    recipients:
    - kore@intechinfo.fr
    - vanbutsele@intechinfo.fr
    on_success: always
    on_failure: always
